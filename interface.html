<!-- templates/index.html -->
<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>DDoS Detection System</title>
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <style>
      .container {
        max-width: 960px;
      }
      .upload-area {
        border: 2px dashed #ccc;
        padding: 2rem;
        text-align: center;
        margin-bottom: 2rem;
        border-radius: 5px;
      }
      .results {
        margin-top: 2rem;
      }
      .progress {
        margin-top: 1rem;
      }
    </style>
  </head>
  <body>
    <div class="container py-5">
      <h1 class="text-center mb-4">DDoS Detection System</h1>
      <p class="text-center mb-4">
        Upload PCAP files from Wireshark to detect DDoS attacks
      </p>

      <div class="row">
        <div class="col-md-6">
          <div class="card">
            <div class="card-header">
              <h5>Single File Analysis</h5>
            </div>
            <div class="card-body">
              <div class="upload-area" id="singleUploadArea">
                <p>Drag & drop a PCAP file here or</p>
                <input
                  type="file"
                  id="singleFileInput"
                  class="d-none"
                  accept=".pcap,.pcapng"
                />
                <button
                  class="btn btn-primary"
                  onclick="document.getElementById('singleFileInput').click()"
                >
                  Select File
                </button>
              </div>
              <div class="progress d-none" id="singleProgress">
                <div
                  class="progress-bar"
                  role="progressbar"
                  style="width: 0%"
                ></div>
              </div>
            </div>
          </div>
        </div>

        <div class="col-md-6">
          <div class="card">
            <div class="card-header">
              <h5>Batch Analysis</h5>
            </div>
            <div class="card-body">
              <div class="upload-area" id="batchUploadArea">
                <p>Drag & drop multiple PCAP files here or</p>
                <input
                  type="file"
                  id="batchFileInput"
                  class="d-none"
                  accept=".pcap,.pcapng"
                  multiple
                />
                <button
                  class="btn btn-primary"
                  onclick="document.getElementById('batchFileInput').click()"
                >
                  Select Files
                </button>
              </div>
              <div class="progress d-none" id="batchProgress">
                <div
                  class="progress-bar"
                  role="progressbar"
                  style="width: 0%"
                ></div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <div class="results d-none" id="resultsSection">
        <h3>Analysis Results</h3>
        <div id="resultsContainer"></div>
      </div>
    </div>

    <script>
      // Handle drag and drop for both single and batch uploads
      const singleUploadArea = document.getElementById("singleUploadArea");
      const batchUploadArea = document.getElementById("batchUploadArea");
      const singleFileInput = document.getElementById("singleFileInput");
      const batchFileInput = document.getElementById("batchFileInput");
      const singleProgress = document.getElementById("singleProgress");
      const batchProgress = document.getElementById("batchProgress");
      const resultsSection = document.getElementById("resultsSection");
      const resultsContainer = document.getElementById("resultsContainer");

      // Prevent default drag behaviors
      ["dragenter", "dragover", "dragleave", "drop"].forEach((eventName) => {
        singleUploadArea.addEventListener(eventName, preventDefaults, false);
        batchUploadArea.addEventListener(eventName, preventDefaults, false);
      });

      // Highlight drop area when item is dragged over it
      ["dragenter", "dragover"].forEach((eventName) => {
        singleUploadArea.addEventListener(eventName, highlight, false);
        batchUploadArea.addEventListener(eventName, highlight, false);
      });

      ["dragleave", "drop"].forEach((eventName) => {
        singleUploadArea.addEventListener(eventName, unhighlight, false);
        batchUploadArea.addEventListener(eventName, unhighlight, false);
      });

      // Handle dropped files
      singleUploadArea.addEventListener("drop", handleSingleDrop, false);
      batchUploadArea.addEventListener("drop", handleBatchDrop, false);

      // Handle file selection via input
      singleFileInput.addEventListener("change", handleSingleFileSelect, false);
      batchFileInput.addEventListener("change", handleBatchFileSelect, false);

      function preventDefaults(e) {
        e.preventDefault();
        e.stopPropagation();
      }

      function highlight(e) {
        e.currentTarget.style.borderColor = "#007bff";
        e.currentTarget.style.backgroundColor = "#f8f9fa";
      }

      function unhighlight(e) {
        e.currentTarget.style.borderColor = "#ccc";
        e.currentTarget.style.backgroundColor = "";
      }

      function handleSingleDrop(e) {
        const dt = e.dataTransfer;
        const files = dt.files;
        if (files.length > 0) {
          uploadFile(files[0], false);
        }
      }

      function handleBatchDrop(e) {
        const dt = e.dataTransfer;
        const files = dt.files;
        if (files.length > 0) {
          uploadFiles(files, true);
        }
      }

      function handleSingleFileSelect(e) {
        if (e.target.files.length > 0) {
          uploadFile(e.target.files[0], false);
        }
      }

      function handleBatchFileSelect(e) {
        if (e.target.files.length > 0) {
          uploadFiles(e.target.files, true);
        }
      }

      function uploadFile(file, isBatch) {
        const formData = new FormData();
        formData.append("file", file);

        const progressBar = isBatch ? batchProgress : singleProgress;
        progressBar.classList.remove("d-none");

        fetch(isBatch ? "/batch_predict" : "/upload", {
          method: "POST",
          body: formData,
        })
          .then((response) => response.json())
          .then((data) => {
            progressBar.classList.add("d-none");
            displayResults(data, isBatch);
          })
          .catch((error) => {
            progressBar.classList.add("d-none");
            alert("Error uploading file: " + error.message);
          });

        // Simulate progress (in a real app, you'd use XMLHttpRequest for progress events)
        let width = 0;
        const interval = setInterval(() => {
          if (width >= 100) {
            clearInterval(interval);
          } else {
            width += 5;
            progressBar.querySelector(".progress-bar").style.width =
              width + "%";
          }
        }, 100);
      }

      function uploadFiles(files, isBatch) {
        const formData = new FormData();
        for (let i = 0; i < files.length; i++) {
          formData.append("files", files[i]);
        }

        const progressBar = isBatch ? batchProgress : singleProgress;
        progressBar.classList.remove("d-none");

        fetch("/batch_predict", {
          method: "POST",
          body: formData,
        })
          .then((response) => response.json())
          .then((data) => {
            progressBar.classList.add("d-none");
            displayResults(data, isBatch);
          })
          .catch((error) => {
            progressBar.classList.add("d-none");
            alert("Error uploading files: " + error.message);
          });

        // Simulate progress
        let width = 0;
        const interval = setInterval(() => {
          if (width >= 100) {
            clearInterval(interval);
          } else {
            width += 5;
            progressBar.querySelector(".progress-bar").style.width =
              width + "%";
          }
        }, 100);
      }

      function displayResults(data, isBatch) {
        resultsSection.classList.remove("d-none");

        if (isBatch && data.results) {
          let html = '<div class="list-group">';
          data.results.forEach((result) => {
            if (result.error) {
              html += `
                            <div class="list-group-item list-group-item-danger">
                                <h5 class="mb-1">${result.filename}</h5>
                                <p class="mb-1 text-danger">${result.error}</p>
                            </div>
                        `;
            } else {
              const badgeClass = result.prediction.includes("DDoS")
                ? "bg-danger"
                : "bg-success";
              html += `
                            <div class="list-group-item">
                                <div class="d-flex w-100 justify-content-between">
                                    <h5 class="mb-1">${result.filename}</h5>
                                    <span class="badge ${badgeClass}">${
                result.prediction
              }</span>
                                </div>
                                <p class="mb-1">Confidence: ${(
                                  result.confidence * 100
                                ).toFixed(2)}%</p>
                                <small>Processed: ${new Date(
                                  result.timestamp
                                ).toLocaleString()}</small>
                            </div>
                        `;
            }
          });
          html += "</div>";
          resultsContainer.innerHTML = html;
        } else if (!isBatch) {
          if (data.error) {
            resultsContainer.innerHTML = `
                        <div class="alert alert-danger" role="alert">
                            <h4 class="alert-heading">Error</h4>
                            <p>${data.error}</p>
                        </div>
                    `;
          } else {
            const badgeClass = data.prediction.includes("DDoS")
              ? "bg-danger"
              : "bg-success";
            resultsContainer.innerHTML = `
                        <div class="card">
                            <div class="card-header d-flex justify-content-between">
                                <span>${data.filename}</span>
                                <span class="badge ${badgeClass}">${
              data.prediction
            }</span>
                            </div>
                            <div class="card-body">
                                <h5 class="card-title">Analysis Results</h5>
                                <p class="card-text">Confidence: ${(
                                  data.confidence * 100
                                ).toFixed(2)}%</p>
                                <p class="card-text"><small class="text-muted">Processed: ${new Date(
                                  data.timestamp
                                ).toLocaleString()}</small></p>
                            </div>
                        </div>
                    `;
          }
        }
      }
    </script>
  </body>
</html>
